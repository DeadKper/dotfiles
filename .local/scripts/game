#!/bin/fish

set -l known flags g e
set -l flags
set -l remove

for i in (seq (count $argv))
    if echo -- $argv[$i] | rg -q -- '^-'
        if test "$argv[$i]" = --
            break
        end
        echo -- $argv[$i] | sd -- '^-' '' | string split '' | while read -l letter
            if contains $letter $known
                set -a flags $letter
                if not contains $i $remove
                    set -a remove $i
                end
            end
        end
    end
end

for i in (seq (count $remove) -1 1)
    set -e argv[$i]
end

set -l command $argv

if type gamemoderun &>/dev/null
    set command gamemoderun $command
end

if contains g $flags; and type gamescope &>/dev/null
    set -l opt_flag
    if contains e $flags
        set -a opt_flag -e
    end

    set -l res (xrandr | rg -F '*+' | sd '^\s+|\s+$|\*\+' '' | sd '\s+|x' '\n')

    set command gamescope $opt_flag -W "$res[1]" -H "$res[2]" -b -o 5 --force-grab-cursor $command
end

if echo -- "$argv" | rg -qv '^\s*$'
    $command
else
    echo -- $command
end
