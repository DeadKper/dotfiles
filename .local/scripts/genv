#!/usr/bin/env bash

function main() {
  # Default vars
  ENV=(
    DXVK_HUD=compiler
    __GL_SHADER_DISK_CACHE=1
    __GL_SHADER_DISK_CACHE_SKIP_CLEANUP=1
  )
  DXVK_CONFIG=()
  VKD3D_CONFIG=(
    force_host_cached
  )
  WINEDLLOVERRIDES=()
  VKD3D_DISABLE_EXTENSIONS=()
  GAMESCOPE_ARGS=()
  EXEC=()

  USE_GAMESCOPE=
  USE_GAMEMODE=true
  USE_MANGOHUD=true

  # Generated, do not modify
  COMMAND=()
  POSITIONAL_ARGS=()

  parse "$@"
  config

  if [[ "${#POSITIONAL_ARGS[@]}" -eq 0 ]]; then
    printf "%s\n" "${COMMAND[@]}" "${POSITIONAL_ARGS[@]}" | sed -r "s/([^ ]* .*)/'\1'/" | sed -z 's/\n/ /g;s/\s*$/\n/'
  else
    printf "%s\n" "${COMMAND[@]}" "${POSITIONAL_ARGS[@]}" | sed -r "s/([^ ]* .*)/'\1'/" | sed -z 's/\n/ /g;s/\s*$/\n/' > ~/.cache/genv
    "${COMMAND[@]}" "${POSITIONAL_ARGS[@]}"
  fi
}

function config() {
  if [[ "${POSITIONAL_ARGS[*]}" == */MonsterHunterWilds.exe ]]; then
    ENV+=(
      MESA_DISK_CACHE_SINGLE_FILE=0
      PROTON_ENABLE_NGX_UPDATER=1
      PROTON_HIDE_NVIDIA_GPU=0
      PROTON_ENABLE_NVAPI=1
      VKD3D_DEBUG=none
    )
    VKD3D_DISABLE_EXTENSIONS+=(
      VK_NV_low_latency2
    )
    WINEDLLOVERRIDES+=(
      dinput8=n,b
    )
  elif [[ "${POSITIONAL_ARGS[*]}" == */MonsterHunterRise.exe ]]; then
    WINEDLLOVERRIDES+=(
      dinput8=n,b
    )
  fi

  if [[ -n "$USE_MANGOHUD" ]] && command -v mangohud &>/dev/null; then
    if [[ -n "$USE_GAMESCOPE" ]]; then
      GAMESCOPE_ARGS+=(--mangoapp)
    else
      ENV+=(MANGOHUD=1)
    fi
  fi

  if [[ -n "$USE_GAMEMODE" ]] && command -v gamemoderun &>/dev/null; then
    COMMAND+=("$(command -v gamemoderun)")
  fi

  if [[ -n "$USE_GAMESCOPE" ]] && command -v gamescope &>/dev/null; then
    COMMAND+=("$(command -v gamescope)" "${GAMESCOPE_ARGS[@]}" --)
  fi

  if [[ "${#DXVK_CONFIG[@]}" -gt 0 ]]; then
    ENV=("DXVK_CONFIG=$(printf '%s\n' "${DXVK_CONFIG[@]}" | sort -u | sed -z 's/\n/,/g;s/,$//')" "${ENV[@]}")
  fi

  if [[ "${#VKD3D_CONFIG[@]}" -gt 0 ]]; then
    ENV=("VKD3D_CONFIG=$(printf '%s\n' "${VKD3D_CONFIG[@]}" | sort -u | sed -z 's/\n/,/g;s/,$//')" "${ENV[@]}")
  fi

  if [[ "${#VKD3D_DISABLE_EXTENSIONS[@]}" -gt 0 ]]; then
    ENV=("VKD3D_DISABLE_EXTENSIONS=$(printf '%s\n' "${VKD3D_DISABLE_EXTENSIONS[@]}" | sort -u | sed -z 's/\n/,/g;s/,$//')" "${ENV[@]}")
  fi

  if [[ "${#WINEDLLOVERRIDES[@]}" -gt 0 ]]; then
    ENV=("WINEDLLOVERRIDES=$(printf '%s\n' "${WINEDLLOVERRIDES[@]}" | sort -u | sed -z 's/\n/ /g;s/ $//')" "${ENV[@]}")
  fi

  if [[ "${#ENV[@]}" -gt 0 ]]; then
    COMMAND=(env "${ENV[@]}" "${COMMAND[@]}")
  fi
}

function parse() {
  local option
  local next
  local last
  local count

  unset option
  unset next

  while [[ $# -gt 0 ]]; do
    if [[ "$1" == "$last" && "$#" == "$count" ]]; then
      echo infinite loop found, termintaing >&2
      exit 1
    fi

    if [[ -n "${next+x}" && "$next" == "$1" ]]; then
      shift
      set -- "-$next" "$@"
    fi

    if [[ -n "${next+x}" ]]; then
      unset option
      unset next
    fi

    [[ "$1" == -* ]] || break

    if [[ "$1" == -- ]]; then
      shift
      break
    elif [[ "$1" == --* ]]; then
      option="$1"
    elif [[ "$1" == -* ]]; then
      option="$1"
      if [[ "${#option}" -gt 2 ]]; then
        next="${option[@]:2}"
        option="${option[@]:0:2}"
        shift
        set -- "$option" "$next" "$@"
      fi
    else
      break
    fi

    last="$1"
    count="$#"

    case "$1" in
      -g) # use gamemode
        USE_GAMEMODE=true
        shift
        ;;
      -G) # disable gamemode
        USE_GAMEMODE=
        shift
        ;;
      -m) # use mangohud
        USE_MANGOHUD=true
        shift
        ;;
      -M) # disable mangohud
        USE_MANGOHUD=
        shift
        ;;
      -s) # use gamescope
        USE_GAMESCOPE=true
        local display="$(xrandr | grep '\*+$')"
        GAMESCOPE_ARGS=(
          --output-width "$(sed 's/^\s*//;s/x.*//' <<< "$display")"
          --output-height "$(sed 's/^\s*[^x]*x//;s/\s.*//' <<< "$display")"
          # --nested-refresh "$(sed -E 's/.*\s([0-9.]+)\*\+$/\1/' <<< "$display" | awk '{printf("%.0f\n",$0+0.5)}')"
          # --framerate-limit "$(sed -E 's/.*\s([0-9.]+)\*\+$/\1/' <<< "$display" | awk '{printf("%.0f\n",$0+0.5)}')"
          # --fullscreen
          --adaptive-sync
          --borderless
          --nested-unfocused-refresh 5
          "${GAMESCOPE_ARGS[@]}"
        )
        shift
        ;;
      -S) # disable gamescope
        USE_GAMESCOPE=
        shift
        ;;
      -e) # use gamescope steam integration
        GAMESCOPE_ARGS+=(--steam)
        shift
        ;;
      -y) # expose wayland to gamescope
        GAMESCOPE_ARGS+=(--expose-wayland --backend wayland)
        shift
        ;;
      -w) # (WIDTH) set gamescope width
        GAMESCOPE_ARGS+=(--nested-width "$2")
        shift 2 || { usage && exit 1; }
        ;;
      -h) # (HEIGHT) set gamescope height
        GAMESCOPE_ARGS+=(--nested-height "$2")
        shift 2 || { usage && exit 1; }
        ;;
      --install) # symlink this app to /bin/ (requires sudo)
        sudo ln -s "$0" /bin/
        exit 0
        ;;
      --help) # print help message
        usage
        exit 0
        ;;
    esac
  done

  [[ $# -gt 0 ]] && POSITIONAL_ARGS+=("$@")
}

function usage() {
  printf '%s\n' \
    "usage: $(basename "$0") [OPTIONS] [ARGUMENTS]" \
    "" \
    options:
  sed -zE 's/.*\sparse\(\)\s*\{\n*//;s/\n\}\n.*/\n/' "$0" \
    | grep -E '^\s*-[a-zA-Z0-9|\-]+\)\s*#' \
    | sed 's/^\s*/  /;s/[|]/, /g;s/[)]\s*#\s*/\t/' \
    | sed -E 's/\t\(([^\)]+)\)\s*/ \1\t/' \
    | column -s $'\t' -t
}

main "$@"
